input = DATA.read.chomp.split("\n")
testcase = <<-END.split("\n")
     |
     |  +--+
     A  |  C
 F---|----E|--+
     |  |  |  D
     +B-+  +--+
END

class Tubes
  def self.seen(input)
    new(input).tap{|t| t.step until t.done? }.seen.join
  end

  def self.steps(input)
    new(input).tap{|t| t.step until t.done? }.steps
  end

  attr_reader :input, :pos, :seen, :steps

  def initialize(input)
    @input = input
    @pos = [0, input.first.index("|")]
    @height = input.size
    @width = input.map(&:size).max

    @seen = []
    @dir = :down
    @steps = 0
  end

  def done?
    @done || pos[0] < 0 || pos[0] >= @height || pos[1] < 0 || pos[1] >= @width
  end

  def step
    # visualize
    offsets = {up: [-1, 0], right: [0, 1], down: [1, 0], left: [0, -1]}
    dirs = offsets.keys

    case cur
    when " "
      return @done = true
    when "+"
      @dir, off = offsets.find do |dir, off|
        (dirs.index(@dir) - dirs.index(dir)).abs != 2 &&
          ![nil, " ", "*"].include?(get(pos, off))
      end

      move off
    else
      move offsets[@dir]
    end

    @seen.push(cur) if ("A".."Z").include?(cur)
    @steps += 1
  end

  def visualize
    vis = input.dup
    vis[pos[0]] = vis[pos[0]].dup
    vis[pos[0]][pos[1]] = "*"
    puts vis; puts
  end

private

  def move(offset)
    pos[0] += offset[0]
    pos[1] += offset[1]
  end

  def cur(val = nil)
    val ? set(pos, val) : get(pos)
  end

  def get(loc, off = [0, 0])
    pos = [loc[0] + off[0], loc[1] + off[1]]
    return nil if pos[0] < 0 && pos[1] < 0

    row = input[pos[0]]
    row ? row[pos[1]] : nil
  end

  def set(pos, val)
    return nil if pos[0] < 0 && pos[1] < 0

    row = input[pos.first]
    row[pos.last] = val if row
  end

end

puts "part 1"
raise "oh no" unless Tubes.seen(testcase) == "ABCDEF"
puts Tubes.seen(input)

puts "part 2"
raise "oh no" unless Tubes.steps(testcase) == 38
puts Tubes.steps(input)

__END__
                                                                                                                                                         |
                                                 +-------------------------------------------------------------------------------------------------------------------------------------------+
                                                 |                                                                                                       |                                   |
 +---------+                                     |         +---------------+         +-------------+           +---+   +-----------------------------------------------------------------+   |
 |         |                                     |         |               |         |             |           |   |   |                                 |                               |   |
 |         |         +---------------+       +---|-------------------------|---------|---+         |           +-----------------------------------------|-------------------------------|-------------+
 |         |         |               |       |   |         |               |         |   |         |               |   |                                 |                               |   |         |
 +-------------------------------------------|---|-------------------------|-------------|-------------------------|---|---------------------------+     |             +---+ +-------------------+ +-+ |
           |         |               |       |   |         |               |         |   |         |               |   |                           |     |             |   | |           |   |   | | | |
 +---------|---------+               |       +-----------------------------|---------|---|---------|---------------|------D--------------------------------------------------|-------------------+ | | |
 |         |                         |           |         |               |         |   |         |               |   |                           |     |             |   | |           |   |     | | |
 |   +-------------------------------------------|-------+ |               |         |   |       +-|-----+     +---------------------------------+ | +---|-------------|-------------------+ |     | | |
 |   |     |                         |           |       | |               |         |   |       | |     |     |   |   |                         | | |   |             |   | |           | | |     | | |
 |   |     |                       +---------+   |       | |               |         |   |       | |     |     |   |   |           +-------------|---|---|-------------+   | |           | | |     | | |
 |   |     |                       | |       |   |       | |               |         |   |       | |     |     |   |   |           |             | | |   |                 | |           | | |     | | |
 | +-------------------+           | | +-----------------|-|-------------------------|---|-------------+ | +-+ +---|-----------------+   +-------|----R--|-----------------------+ +-+   | | +-+   | | |
 | | |     |           |           | | |     |   |       | |               |         |   |       | |   | | | |     |   |           | |   |       | | |   |                 | |   | | |   | |   |   | | |
 | | |     |           |           | | |     |   |       | |     +-+ +-------------------|---------|---|-----------|---------------|-|---|---------|-|---|-------------+   | |   | | |   | |   |   | | |
 | | |     |           |           | | |     |   |       | |     | | |     |         |   |       | |   | | | |     |   |           | |   |       | | |   |             |   | |   | | |   | |   |   | | |
 | | |     |         +-|-------------------------|---------|---------|---------+     |   |       | |   | | | |     |   |           +-----|-------+ | |   |             |   | |   | +-|---|-+   |   | | |
 | | |     |         | |           | | |     |   |       | |     | | |     |   |     |   |       | |   | | | |     |   |             |   |         | |   |             |   | |   |   |   |     |   | | |
 | | |     |         | |           | +-----------|---------+     | | |     | +-|-----|---|-------|-----|-----|-----------------------|---+     +---------|-------------|-------------|---|-------------+
 | | |     |         | |           |   |     |   |       |       | | |     | | |     |   |       | |   | | | |     |   |             |         |   | |   |             |   | |   |   |   |     |   | |
 | +-|-----------------------------|---------|---|-------|-----------------|-|-|-----|-----------|---------------------------------------------+   | |   |             |   | |   |   |   |     |   | |
 |   |     |         | |           |   |     |   |       |       | | |     | | |     |   |       | |   | | | |     |   |             |             | |   |             |   | |   |   |   |     |   | |
 |   |     |         | |     +-+   |   |     |   |       |       | | |     | | |     |   |       | |   | | | |     |   |             |       +-----|-|---|-------+     |   | |   +-------|-------+ | |
 |   |     |         | |     | |   |   |     |   |       |       | | |     | | |     |   |       | |   | | | |     |   |             |       |     | |   |       |     |   | |       |   |     | | | |
 |   |     |         | |     | +-------|-----|-----------|-----------|---+ | | |     |   |       | |   | | | +-----|---|-+ +---------|-------|-------|---|-------|-----|---+ |       |   |     | | | |
 |   |     |         | |     |     |   |     |   |       |       | | |   | | | |     |   |       | |   | | |       |   | | |         |       |     | |   |       |     |     |       |   |     | | | |
 | +-------------------|-----|---------|-----|---|---------------|-|-------|-|-------|-----------+ | +---|-|---+   |   | +---+       |       +-----------|-------|-----------|-------|---------|-+ | |
 | | |     |         | |     |     |   |     |   |       |       | | |   | | | |     |   |         | | | | |   |   |   |   | |       |             | |   |       |     |     |       |   |     |   | |
 | | |     |         | |     |     |   | +-------|-------------------------|---|---------+         | | | | |   |   |   |   | |       |       +-----|-|-----------+   +---------------+   |     |   | |
 | | |     |         | |     |     |   | |   |   |       |       | | |   | | | |     |             | | | | |   |   |   |   | |       |       |     | |   |           | |     |           |     |   | |
 | | |     |         | |     |     |   | |   |   |       |       | | |   | | | |     |             | | | | |   |   |   +---|-|-------|-------|-----|-----|-------+   | |     |           | +---|---|-|-+
 | | |     |         | |     |     |   | |   |   |       |       | | |   | | | |     |             | | | | |   |   |       | |       |       |     | |   |       |   | |     |           | |   |   | | |
 | | |     |         | |     |     |   | |   |   |       |       | | |   | | | |     |             | | | | |   | +---------|-|---------------|-----|-----|---+   |   | |     |           | |   |   | | |
 | | |     |         S |     |     |   | |   |   |       |       | | |   | | | |     |             | | | | |   | | |       | |       |       |     | |   |   |   |   | |     |           | |   |   | | |
 | | |     |   +-------|-----|--------F|-|---|---|---------------------+ | | | |     |             | | | | |   | | |       | +-----------+   +-+ +-|-|---|---|-------|-----------------+ | |   |   | | |
 | | |     |   |     | |     |     |   | |   |   |       |       | | | | | | | |     |             | | | | |   | | |       |         |   |     | | | |   |   |   |   | |     |         | | |   |   | | |
 | | |     |   |     | |     |     |   | |   |   |       |       | | | | | | +-|-----+         +---|-----------+ | |     +---------------|---------------|---|-----+ +-|---------+     | | |   |   | | |
 | | |     |   |     | |     |     |   | |   |   |       |       | | | | | |   |               |   | | | | |     | |     | |         |   |     | | | |   |   |   | |   |     |   |     | | |   |   | | |
 | | |     | +---+   | +-----|-----|---------------------|-------|-|---|-----------------------|-------|-|-------|-------|-----------|---|---------|-----|-------|-|-+ |     |   |     | | |   |   | | |
 | | |     | | | |   |       |     |   | |   |   |       |       | | | | | |   |               |   | | | | |     | |     | |         |   |     | | | |   |   |   | | | |     |   |     | | |   |   | | |
 +-|---+   | | | +---------------------------|-------------------------|-|---------------------|---------|---------------|-----------|-------+ | | | |   |   |   | | | |     |   |     | | |   |   | | |
   | | |   | | |     |       |     |   | |   |   |       |       | | | | | |   |               |   | | | | |     | |     | |         |   |   | | | | |   |   |   | | | |     |   |     | | |   |   | | |
   | | |   | | |     |       |     |   | |   |   |       |   +---|---|-|-|-----|-------------------|---|---|-------------|-----------------------|-|-|-+ |   |   | | | |     |   |     | | |   |   | | |
   | | |   | | |     |       |     |   | |   |   |       |   |   | | | | | |   |               |   | | | | |     | |     | |         |   |   | | | | | | |   |   | | | |     |   |     | | |   |   | | |
   | | |   | | |     |       |     |   | |   |   |       +---|---|-|---|-|---+ |               |   | | | | +-----|-|-----|---+ +-----|---+   | | | | | | |   |   | | | |     |   |   +-|-|-+   |   | | |
   | | |   | | |     |       |     |   | |   |   |           |   | | | | | | | |               |   | | | |       | |     | | | |     |       | | | | | | |   |   | | | |     |   |   | | |     |   | | |
   | | |   | | |     |       |     |   | |   |   |           |   | | | +-|-|-|-|-------------------|-|-------------|---+ | | | |     |       | | | | | | |   |   | | | |     |   |   | | | +---|-+ | | |
   | | |   | | |     |       |     |   | |   |   |           |   | | |   | | | |               |   | | | |       | |   | | | | |     |       | | | | | | |   |   | | | |     |   |   | | | |   | | | | |
   | | +-----|-+     |   +---------|-----|---|---------------|-----|---------|-----------------|---|-|-|-----------|-------|---|-----|-------|-|-|---|-|---------|-|---|---------|---|-----+   | | | | |
   | |     | |       |   |   |     |   | |   |   |           |   | | |   | | | |               |   | | | |       | |   | | | | |     |       | | | | | | |   |   | | | |     |   |   | | |     | | | | |
 +---|---+ | |       |   |   |     |   | |   +---------+     |   | | |   | | | |             +-|---|---|---------|-------|-|-|-|-----|-------------|---|-----|-----|---|-------------|-+ |     | | | | |
 | | |   | | |       |   |   |     |   | |       |     |     |   | | |   | | | |             | |   | | | |       | |   | | | | |     |       | | | | | | |   |   | | | |     |   |   |   |     | | | | |
 | | |   | | |       |   |   |     |   | |       |     |     |   | | |   | | | |             | |   | | | |       | | +-----|---+     |       | | +-|-|---|---|---|-----|-----|---|-------|---+ | | | | |
 | | |   | | |       |   |   |     |   | |       |     |     |   | | |   | | | |             | |   | | | |       | | | | | | |       |       | |   | | | |   |   | | | |     |   |   |   |   | | | | | |
 | | |   | +-|-------|---|-+ |     |   | |       |     |     |   | | |   | | | |             | |   | | | |   +-----|-|-|---|-|-------|-------|-----|-|-+ |   |   | | | |     |   |   |   |   | | | | | |
 | | |   |   |       |   | | |     |   | |       |     |     |   | | |   | | | |             | |   | | | |   |   | | | | | | |       |       | |   | |   |   |   | | | |     |   |   |   |   | | | | | |
 | | | +-------+ +---|---|-|-----------|-|-------|-----|-----|---|-|-----|-----|-------------|-----|-----------------|---+ | |       |       | +---|-+ +-----|-------|-----------|---+   |   | | | | | |
 | | | | |   | | |   |   | | |     |   | |       |     |     |   | | |   | | | |             | |   | | | |   |   | | | |   | |       |       |     |   | |   |   | | | |     |   |       |   | | | | | |
 | | | | |   | | |   |   | | |     |   | |       |     |     | +-|-+ |   | | | |             | |   | | | |   |   | | | |   | |       |       |     |   | |   |   | | +-------|-+ |       |   | | | | | |
 | | | | |   | | |   |   | | |     |   | |       |     |     | | |   |   | | | |             | |   | | | |   |   | | | |   | |       |       |     |   | |   |   | |   |     | | |       |   | | | | | |
 | | | +-|-----|-------------|---------|---------|-----------|-----------------|-------------|-|---|-------+ |   | | | |   | |       |   +-------+ |   | |   |   | |   +-----|-|-|-----------|---|-|---+
 | | |   |   | | |   |   | | |     |   | |       |     |     | | |   |   | | | |             | |   | | | | | |   | | | |   | |       |   |   |   | |   | |   |   | |         | | |       |   | | | | |
 | | |   |   | | |   |   | | |     |   | |       |     |     | | |   |   +-|-|-|---------------------|-----|-|-----|-|-------------------|---|-+ | |   | |   |   | |         | | |       |   | | | | |
 | | |   |   | | |   |   | | |     |   | |       |     |     | | |   |     | | |             | |   | | | | | |   | | | |   | |       |   |   | | | |   | |   |   | |         | | |       |   | | | | |
 | | |   +---|-|-|---------------+ | +-+ |       |     |     | | |   |     | | |             | |   | | | | | |   | | | |   | |       |   | +-+ | +-------|-------------------|---|-------|---------+ |
 | | |       | | |   |   | | |   | | |   |       |     |     | | |   |     | | |             | |   | | | | | |   | | | |   | |       |   | |   |   |   | |   |   | |         | | |       |   | | |   |
 | | |       | | |   |   | | |   | | |   |       |     |     | | |   |     | | |             | |   | | | | | |   | | | |   | |       |   | |   |   |   | |   |   | |         | | |       |   | | |   |
 | | |       | | |   |   | | |   | | |   |       |     |     | | |   |     | | |             | |   | | | | | |   | | | |   | |       |   | |   |   |   | |   |   | |         | | |       |   | | |   |
 | | |     +-----|---|-----|-|---|-|-----|---------+   |     | | |   |     | | |         +-----|-------+ | +-----|---|-------|-------|-----|-----------------|---|-|---------|-|-|-+     |   | | |   |
 | | |     | | | |   |   | | |   | | |   |       | |   |     | | |   |     | | |         |   | |   | |   |   |   | | | |   | |       |   | |   |   |   | |   |   | |         | | | |     |   | | |   |
 | | |     | | | |   |   | | |   | | |   |       | |   +---------------------|-----------------|-----------------|-|-|-|---|-|-------------|-----------------|-----+         | | | |     |   | | |   |
 | | |     | | | |   |   | | |   | | |   |       | |         | | |   |     | | |         |   | |   | |   |   |   | | | |   | |       |   | |   |   |   | |   |   |           | | | |     |   | | |   |
 | | |     | | | |   |   | | |   | | |   |       | |         | | |   |     | | |         |   | |   | |   |   |   | | | |   | |       |   | |   |   |   | |   |   |           | | | |     |   +-------|-+
 | | |     | | | |   |   | | |   | | |   |       | |         | | |   |     | | |         |   | |   | |   |   |   | | | |   | |       |   | |   |   |   | |   |   |           | | | |     |     | |   | |
 | | | +---|-----|---|-----------|-|-|-------------|-----+   +---|-+ |     | | |         |   | |   | |   |   |   | +---------|-----+ |   | |   |   |   | |   |   |           | | | |     |     | |   | |
 | | | |   | | | |   |   | | |   | | |   |       | |     |     | | | |     | | |         |   | |   | |   |   |   |   | |   | |     | |   | |   |   |   | |   |   |           | | | |     |     | |   | |
 | | | | +-+ +---|---------+ |   | | +---|-------|-|-----|---------|-|-----|-------------------|---|-|---|---------------------------|---|-|-------------|-------|-----------+ | | |   +---------+ +---+
 | | | | |     | |   |   |   |   | |     |       | |     |     | | | |     | | |         |   | |   | |   |   |   |   | |   | |     | |   | |   |   |   | |   |   |             | | |   | |     |   | |
 | | | | +-+   | |   |   +---|-----|-----+       | |     +-------|-|-|-----|-|-|-------+ |   | |   | |   |   |   |   | |   | |     | |   | |   |   |   | |   |   |             +-|-|---|-------------|-+
 | | | |   |   | |   |       |   X |             | |           | | | |     | | |       | |   | |   | |   |   |   |   | |   | |     | |   | |   |   |   | |   |   |               | |   | |     |   | | |
 | | | +---|-+ | |   |       |   | |             | |           | | | |     | | |       | |   | |   | |   |   |   |   | |   | |     | |   | |   |   |   | |   +---|-----------------+   | |     |   | | |
 | | |     | | | |   |       |   | |             | |           | | | |     | | |       | |   | |   | |   |   |   |   | |   | |     | |   | |   |   |   | |       |               |     | |     |   | | |
 | | |     | | | |   |   +-------|---------------|-|-------------|-|---------|-----------|---|-----|-----|-----------+ |   | |     +-|-----|---+   |   | +-------|-------+ +-----|-----+ |     |   | | |
 | | |     | | | |   |   |   |   | |             | |           | | | |     | | |       | |   | |   | |   |   |   |     |   | |       |   | |       |   |         |       | |     |       |     |   | | |
 | | |   +---|---|-----------|---|-|-------------|---------------|-|---------------------|-----|---|-----|---|---|-----|-----------+ |   | |       |   |         |     +-|---------------------|-+ | | |
 | | |   | | | | |   |   |   |   | |             | |           | | | |     | | |       | |   | |   | |   |   |   |     |   | |     | |   | |       |   |         |     | | |     |       |     | | | | |
 +-|-|-----|---+ |   |   |   |   | |             | |           | | | |     | | |       | |   | |   | |   |   |   |     |   | |     | |   | |       |   |         |     | | |     |       |     | | | | |
   | |   | | |   |   |   |   |   | |             | |           | | | |     | | |       | |   | |   | |   |   |   |     |   | |     | |   | |       |   |         |     | | |     |       |     | | | | |
   | |   | | |   |   |   |   |   | | +-------------|-----------------|---------|-------|-----|-----|-|---|---|---+     |   | |     +-----|---------|-------------|-----|---|-----|-------|-----|-+ | | |
   | |   | | |   |   |   |   |   | | |           | |           | | | |     | | |       | |   | |   | |   |   |         |   | |       |   | |       |   |         |     | | |     |       |     |   | | |
 +-|-|---|-|-|-------|-----------|---|---+       | |           | | +---------|---------|-|---------------|-------------|---|-+       |   | |       | +-|---------|-------|-------------+ |     |   | | |
 | | |   | | |   |   |   |   |   | | |   |       | |           | |   |     | | |       | |   N |   | |   |   |         |   |         |   | |       | | |         |     | | |     |     | |     |   | | |
 | | |   +-|-|-----------|---|---|-|---------------|-------------|-----+   | | |       | |   | |   | |   |   |         |   |       +-------------+ | | |         |     | | |     | +---|-|-----+   | | |
 | | |     | |   |   |   |   |   | | |   |       | |           | |   | |   | | |       | |   | |   | |   |   |         |   |       | |   | |     | | | |         |     | | |     | |   | |         | | |
 | | +-+   | |   +---|-------|-----|-+   |       | |           | |   | |   | | |       | |   | |   | |   |   |         |   |       | +-------------|---|---------|-----|---------|-----|-----------+ | |
 | |   |   | |       |   |   |   | |     |       | |           | |   | |   | | |       | |   | |   | |   |   |         |   |       |     | |     | | | |         |     | | |     | |   | |           | |
 | |   |   | |       |   |   |   | |     |       | |           | |   | |   | | |       | |   | |   | |   |   |         |   |       |     | |     | | | |         |     | | |     | |   | |           | |
 | |   |   | |       |   |   |   | |     |       | |           | |   | |   | | |       | |   | |   | |   |   |         |   |       |     | |     | | | |         |     | | |     | |   | |           | |
 | |   |   | |       |   |   | +---|---------------|-----------------|-|-------|-------|-----------|-|---|---|---------------------------|-------|-----+         |     | | |     | |   | |   +-----+ | |
 | |   |   | |       |   |   | | | |     |       | |           | |   | |   | | |       | |   | |   | |   |   |         |   |       |     | |     | | |           |     | | |     | |   | |   |     | | |
 | |   |   | | +-------------|-------------------|-|---+       | |   | |   | | |       | |   | |   | |   |   |         |   |       |     | |     | | |           |     | | |     | |   | |   |     | | |
 | |   |   | | |     |   |   | | | |     |       | |   |       | |   | |   | | |       | |   | |   | |   |   |         |   |       |     | |     | | |           |     | | |     | |   | |   |     | | |
 | |   |   | | |     |   |   | | | | +-+ |       | |   | +-------|-----|---|-|----------------P----|-----|---|---------|---|-------------|-|---------|-----------|-----|-|-|-+   | |   | |   |     | | |
 | |   |   | | |     |   |   | | | | | | |       | |   | |     | |   | |   | | |       | |   | |   | |   |   |         |   |       |     | |     | | |           |     | | | |   | |   | |   |     | | |
 | |   |   | | |     |   |   | | | | | +---------|-------|-----|-----|---------|---------------|---------|-------------|-----------|-----|-|-------|---------+   |     | | | |   | |   | |   |     | | |
 | |   |   | | |     |   |   | | | | |   |       | |   | |     | |   | |   | | |       | |   | |   | |   |   |         |   |       |     | |     | | |       |   |     | | | |   | |   | |   |     | | |
 | |   |   | | |     |   |   | | | | | +-|---------------|-----|-------|---|-----------|-------|-----|-------|---------+   |       |     | |     | | |       |   |     | | | |   | |   | |   |     | | |
 | |   |   | | |     |   |   | | | | | | |       | |   | |     | |   | |   | | |       | |   | |   | |   |   |             |       |     | |     | | |       |   |     | | | |   | |   | |   |     | | |
 | |   |   | | |     +-------------|-------------|-------|-----|-----------|-|-|-------|---------------------|-------------|-----------------------|---------|---+     | | +-------|---|-----+   +-+ | |
 | |   |   | | |         |   | | | | | | |       | |   | |     | |   | |   | | |       | |   | |   | |   |   |             |       |     | |     | | |       |         | |   |   | |   | |       |   | |
 | |   |   | | |       +-------|-|-|-|-|-------+ | |   | |     | |   | |   | | |       | |   | |   | |   |   |             |       | +-----|-----|-----------------+   | |   |   +-|-+ | |       | +---+
 | |   |   | | |       | |   | | | | | | |     | | |   | |     | |   | |   | | |       | |   | |   | |   |   |             |       | |   | |     | | |       |     |   | |   |     | | | |       | | |
 | |   |   | | |       | |   | | | | | | |     | | |   | |     | |   | |   +---|-----+ | |   | |   | |   |   |             |       | |   | |     | | |   +---|---------|-|---+     | | | |       | | +-+
 | |   |   | | |       | |   | | | | | | |     | | |   | |     | |   | |     | |     | | |   | |   | |   |   |             |       | |   | |     | | |   |   |     |   | |         | | | |       | |   |
 | |   |   | | |       | |   | | | | | | |     | | |   | |     | |   | |     | |     | | |   +-|-+ +---------|---------+   |       | |   | | +-------|-------------|---|-|---------|-------------+ |   |
 | |   |   | | |       | |   | | | | | | |     | | |   | |     | |   | |     | |     | | |     | |   |   |   |         |   |       | |   | | |   | | |   |   |     |   | |         | | | |         |   |
 | | +-------|-|---------|---|-----|---|-|-----|-|-------|-----|-------|-------|-------|-|-------|---------------------|---|---------|---|-|-----|-|-|---|---|-------+ | |         | | | |     +---+   |
 | | | |   | | |       | |   | | | | | | |     | | |   | |     | |   | |     | |     | | |     | |   |   |   |         |   |       | |   | | |   | | |   |   |     | | | |         | | | |     |       |
 | | | |   | | |       | |   | | | | | | |   +-+ | |   | |   +---------|-------------|---------|-----|---|-----------------+       | |   | | |   | | |   |   |     | +-|---+       | | | |     |       |
 | | | |   | | |       | |   | | | | | | |   |   | |   | |   | | |   | |     | |     | | |     | |   |   |   |         |           | |   | | |   | | |   |   |     |   | | |       | | | |     |       |
 | | | |   | | |       | |   | | | | | | |   |   | |   | |   | | |   | |     | |     | | |     | |   |   | +-|---------------------|---------|---|---|---|-------------|-----------|---|-|-----|---+   |
 | | | |   | | |       | |   | | | | | | |   |   | |   | |   | | |   | |     | |     | | |     | |   |   | | |         |           | |   | | |   | | |   |   |     |   | | |       | | | |     |   |   |
 | | | |   | | |       | |   | | | | | | |   |   | |   | |   | | |   | |     | |     | | |     | |   +-----|-|---------------------|-|---|-|-|-----|-----|---+     |   | | |       | | | |     |   |   |
 | | | |   | | |       | |   | | | | | | |   |   | |   | |   | | |   | |     | |     | | |     | |       | | |         |           | |   | | |   | | |   |         |   | | |       | | | |     |   |   |
 | | | |   | | |       | |   | | | | | | |   |   | +---------|-------|-------|-|---------------|-|---------|-|---------|-----------|-|-----------|---|-----+       |   | | |       | | | |     |   |   |
 | | | |   | | |       | |   | | | | | | |   |   |     | |   | | |   | |     | |     | | |     | |       | | |         |           | |   | | |   | | |   | |       |   | | |       | | | |     |   |   |
 | | | |   | | |       | +---|-|---|-----|---|-----------|---+ | |   | |     | |     | | |     | |       | | |         +-----------|-------|-----|-|-----------------------------------|-|-----|---|-+ |
 | | | |   | | |       |     | | | | | | |   |   |     | |     | |   | |     | |     | | |     | |       | | |                     | |   | | |   | | |   | |       |   | | |       | | | |     |   | | |
 | | | | +-----------------------|-----|-|---+   |     | |     | |   | |     | |     | | |     | |       | | +---------------------|-------|-|-----|-|---|---------|---|-----------|-|-|-----------|-+ |
 | | | | | | | |       |     | | | | | | |       |     | |     | |   | |     | |     | | |     | |       | |                       | |   | | |   | | |   | |       |   | | |       | | | |     |   |   |
 | | +---+ | | |       |     | | | | | +-----------------|-----|-----|---------------|---------------------------------------------|-----|---------|-|-------------------|---------|-----|-----|-----+ |
 | |   |   | | |       |     | | | | |   |       |     | |     | |   | |     | |     | | |     | |       | |                       | |   | | |   | | |   | |       |   | | |       | | | |     |   | | |
 | |   |   | | |       |     | | | | |   |       |     | | +-+ +-----|-------|---------|-----+ | |       | |                       | |   | | |   | | |   | |       | +-|-|-------+ | | | |     |   | | |
 | |   |   | | |       |     | | | | |   |       |     | | | |   |   | |     | |     | | |   | | |       | |                       | |   | | |   | | |   | |       | | | | |     | | | | |     |   | | |
 +-|-----------|-------|-----+ +---+ |   |   +-------------|---------|-------|-------|-|--------------J--|-+                       +-+   | | |   | | |   | |       | | | | |     | | | | |     |   | | |
   |   |   | | |       |         |   |   |   |   |     | | | |   |   | |     | |     | | |   | | |       |                               | | |   | | |   | |       | | | | |     | | | | |     |   | | |
   |   |   | | |       |         |   |   |   |   |     | | | |   |   | |     | |     | | |   +-+ |       |                               | | |   | | |   | |       | | | | |     | | | | |     |   | | |
   |   |   | | |       |         |   |   |   |   |     | | | |   |   | |     | |     | | |       |       |                               | | |   | | |   | |       | | | | |     | | | | |     |   | | |
   |   |   | | |       |         |   |   |   |   |     | | | |   |   | |     | |     +-|---------|---------------------------------------|-|---------|---|-|-------|-+ | | |     | | | | |     |   | | |
   |   |   | | |       |         |   |   |   |   |     | | | |   |   | |     | |       | |       |       |                               | | |   | | |   | |       |   | | |     | | | | |     |   | | |
 +-|-+ |   | | |     +-|---------|-+ |   +-----------------|-|---|---|-|-----|-|-------|-|---------------|---+                           | +-+   | | |   | |       |   | | |   +-|-------|-----|---+ | |
 | | | |   | | |     | |         | | |       |   |     | | | |   |   | |     | |       | |       |       |   |                           |       | | |   | |       |   | | |   | | | | | |     |     | |
 | | | | +-|-|-------------------|-|---------------------+ | |   |   +---------|-----------------------------|---------------------------|---------|-|---+ |       |   | | |   | | | +-|-------|-+   | |
 | | | | | | | |     | |         | | |       |   |     |   | |   |     |     | |       | |       |       |   |                           |       | | |     |       |   | | |   | | |   | |     | |   | |
 | +-|---+ | | |     | |         | | |       |   |     |   | |   |     |     | |       | |       |       | +-|---------------------------|---------|-|-------------|-----|-------|-|---|---------|-+ | |
 |   | |   | | |     | |         | | |       |   |     |   | |   |     |     | |       | |       |       | | |                           |       | | |     |       |   | | |   | | |   | |     | | | | |
 |   | |   | | |     | +---------|-|-|---------------------------------|-----|-|-------|---------|---------|-|---------------------------|---------|-------------+ |   | | +-------|---|-------|-|-+ | |
 |   | |   | | |     |           | | |       |   |     |   | |   |     |     | |       | |       |       | | |                           |       | | |     |     | |   | |     | | |   | |     | |   | |
 +-+ | |   | | |     |   +-------+ | |       |   |     |   | |   |     |     | |       | |       |       | | |                           |       | | |     |     | |   | |     | | |   | |     | +-+ | |
   | | |   | | |     |   |         | |       |   |     |   | |   |     |     | |       | |       |       | | |                           |       | | |     |     | |   | |     | | |   | |     |   | | |
   | | |   | | |     |   |         | |       |   |     |   | |   |     |     | |       | |       |       | | |                           |       | | |     |     | |   | |     | | |   | |     |   | | |
   | | |   | | |     |   |         | |       |   |     |   | |   |     |     | |       | |       |       | | |                           |       | | |     |     | |   | |     | | |   | |     |   | | |
   | | |   | | |     |   |   +-------|-------|---|---------------|-----------------------|---------------|-----------------------------------------|-+     |     +-|---+ |     | | |   | +-------+ | | |
   | | |   | | |     |   |   |     | |       |   |     |   | |   |     |     | |       | |       |       | | |                           |       | |       |       |     |     | | |   |       | | | | |
   | | |   | | |     |   |   | +---|-|-----------|-----|-------+ |     |     | |       | |       |       | | |                           |       | |       |       |     |     | | |   |       | | | | |
   | | |   | | |     |   |   | |   | |       |   |     |   | | | |     |     | |       | |       |       | | |                           |       | |       |       |     |     | | |   |       | | | | |
   | | |   | | |     |   |   +-|-------------|---------------|---------|---------------------------------|-|-------------------------------------|-|---------------------------|-|---+ |       | | | | |
   | | |   | | |     |   |     |   | |       |   |     |   | | | |     |     | |       | |       |       | | |                           |       | |       |       |     |     | | | | |       | | | | |
 +-----------|-|-----------------------------|---|---+ |   | | | +-----------|---------------------------|-|-----------------------------|-----------------|-------------|-----|---|-|---+     | | | | |
 | | | |   | | |     |   |     |   | |       |   |   | |   | | |       |     | |       | |       |       | | |                           |       | |       |       |     |     | | | | | |     | | | | |
 | | | |   | | |     |   |   +-----|-------------+   | |   | | |       |     | |       | |       |       | | |                           |       | |       |       |     |     | | | | | |     | | | | |
 | | | |   | | |     |   |   | |   | |       |       | |   | | |       |     | |       | |       |       | | |                           |       | |       |       |     |     | | | | | |     | | | | |
 | | | +---|-+ +-----|---------|---+ |       |       | +-----|-|-------|-------|-----------------|---------------+                       |       | |       |       |     +-----|-|-+ | | | +-+ | | | | |
 | | |     |         |   |   | |     |       |       |     | | |       |     | |       | |       |       | | |   |                       |       | |       |       |           | |   | | | | | | | | | |
 | | | L---|---+     |   |   | |     |     +-----------------|---------------|---------|---------|-------|---|---|-----------------------|-------|---------|-------|---------------------|-+ | | | | | |
 | | |     |   |     |   |   | |     |     | |       |     | | |       |     | |       | |       |       | | |   |                       |       | |       |       |           | |   | | |   | | | | | |
 +-|---+   |   |     |   |   | |     |     | |       |     | | |       |     | |       +-|---------------|---|---|-----------------------|-------|-----------------------------------|-+ |   | | | | | |
   | | |   |   |     |   |   | |     |     | |       |     | | |       |     | |         |       |       | | |   |                       |       | |       |       |           | |   |   |   | | | | | |
   | | |   |   |     +---|-----|-----+     | |       |     | | |       |     | |         |       |       | | |   +-------------------------------|---------|-------|-----------+ +---------+ | | | | | |
   | | |   |   |         |   | |           | |       |     | | |       |     | |         |       |       | | |                           |       | |       |       |                 |   | | | | | | | |
   | | +---|-----------------|-|-----------|-|---+   |     | | |       +-----|-|-----------------|---------|-|---------------------------|---------|-------+       |                 |   | | | | | | | |
   | |     |   |         |   | |           | |   |   |     | | |             | |         |       |       | | |                           |       | |               |                 |   | | | | | | | |
   +-|---------+         |   | +-----------|-----+   |     | | |             | |         |       |       | | |                 +-----------------|-|---------------|-----------------+   +-+ +-|-|-+ | |
     |     |             |   |             | |       |     | | |             | |         |       |       | | |                 |         |       | |               |                           | |   | |
     |     |             |   |             | |       |     | | |             | |         |       |       | | |                 |         |       | |               |                           | |   | |
     |     |             |   |             | |       |     | | |             | |         |       |       | | |                 |         |       | |               |                           | |   | |
     |     |             |   |             | |       |     | | |             +-------------------|-------|Z--+                 |         |       | +---------------------------------------+   | |   | |
     |     |             |   |             | |       |     | | |               |         |       |       | |                   |         |       |                 |                       |   | |   | |
     |     |             |   |             | |       |     | +-----------------|---------|-------+       | |                   |         |       |                 +-------------------------+ | |   | |
     |     |             |   |             | |       |     |   |               |         |               | |                   |         |       |                                         | | | |   | |
     |     |             |   +-------------|---------|-----|---|---------------+ +---------------------------------------------|-----------------|-------------------------------------------|-|-|-----+
     |     |             |                 | |       |     |   |                 |       |               | |                   |         |       |                                         | | | |   |
     +-----|-------------|-----------------|-|-------+     |   |                 |       |               | |                   |         |       |                                         | | | |   |
           |             |                 | |             |   |                 |       |               | |                   |         |       |                                         | | | |   |
           |             +-----------------|---------------|---------------------+       |               | |                   |         |       |                                         | +---|-----+
           |                               | |             |   |                         |               | |                   |         |       |                                         |   | |   | |
           |                   +---------------------------|---|-------------------------|-----------------|-------------------|---------+       |           +-----------------------------+   | |   | |
           |                   |           | |             |   |                         |               | |                   |                 |           |                                 | |   | |
           |                   |           | |             |   |                         |               | +-------+           |                 +-----------|-----------------------------------+   | |
           |                   |           | |             |   |                         |               |         |           |                             |                                 |     | |
           |                   |           | |             |   |                         |               +---------|-----------------------------------------|---------------------------------+   +-+ |
           |                   |           | |             |   |                         |                         |           |                             |                                     |   |
           |                   +-------------|-------------|---|---------------------------------------------------|-----------|-----------------------------|-----------------------------------------+
           |                               | |             |   |                         |                         |           |                             |                                     |
           |                               +-|-----------------+                         +-------------------------|-----------+                             +---------------+                 +---+
           |                                 |             |                                                       |                                                         |                 |
           +---------------------------------+             +-------------------------------------------------------+                                                         +-----------------+
